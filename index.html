<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tiny-VAC // CORE</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-green: #39ff14;
            --neon-red: #ff003c;
            --glass: rgba(10, 10, 20, 0.9);
            --border: rgba(255, 255, 255, 0.1);
        }

        /* --- BOIDS CANVAS STYLE --- */
        #boids-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Behind UI */
            background: #050505;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: transparent; /* Changed to let canvas show */
            color: #e0e0e0;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-blue);
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
            margin: 20px 0;
            font-size: 1.6rem;
            text-transform: uppercase;
        }

        .status-box {
            width: 100%;
            max-width: 1100px;
            background: var(--glass);
            padding: 12px;
            border-left: 3px solid var(--neon-blue);
            margin-bottom: 20px;
            box-sizing: border-box;
            font-family: 'Orbitron';
            font-size: 0.75rem;
            backdrop-filter: blur(5px);
        }

        .dashboard {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 1100px;
        }

        @media (min-width: 768px) {
            .dashboard { display: grid; grid-template-columns: 1fr 1fr; }
        }

        .alarms, .devices {
            background: var(--glass);
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            margin-top: 0;
            color: #888;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .message-list, .device-list {
            list-style: none;
            padding: 0; 
            margin: 0;
            width: 100%;
        }

        .message-list li, .device-list li {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px 15px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 0.95rem;
            transition: background 0.2s;
        }

        .alert-item { border-right: 4px solid var(--neon-red); color: #fff; }
        .warning-item { border-right: 4px solid #ffcc00; color: #ffcc00; }
        .device-online { border-right: 4px solid var(--neon-green); color: var(--neon-green); }
        .device-warning { border-right: 4px solid #ffcc00; color: #ffcc00; }
        .device-offline { border-right: 4px solid #444; opacity: 0.6; color: #888; }

        @keyframes pulse-blink {
            0% { filter: brightness(1); }
            50% { filter: brightness(2); box-shadow: inset 0 0 10px rgba(255,255,255,0.1); }
            100% { filter: brightness(1); }
        }
        .blink-active { animation: pulse-blink 0.4s ease-in-out; }

        .settings-icon { cursor: pointer; color: #fff; font-size: 1.2rem; }

        #settings-ui {
            position: fixed;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 95%; max-width: 400px;
            background: #0a0a14;
            border: 2px solid var(--neon-blue);
            padding: 20px;
            z-index: 1000;
            display: none;
            border-radius: 12px;
            box-sizing: border-box;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
        }

        .pressure-label {
            background: #000;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            justify-content: space-around;
            border: 1px solid #333;
            font-family: 'Orbitron';
        }

        .set-pressure { color: var(--neon-blue); font-size: 2rem; }
        .real-pressure { color: #fff; font-size: 1.5rem; opacity: 0.7; }

        .settings-button { font-family: 'Orbitron'; padding: 12px; border: none; cursor: pointer; width: 100%; border-radius: 4px; margin-bottom: 10px; font-weight: bold; }
        .settings-plus, .settings-minus { background: #333; color: white; width: 48%; font-size: 1.5rem; }
        .settings-save { background: var(--neon-blue); color: #000; }
        
        .setting-group { margin-bottom: 12px; }
        .setting-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #888; }
        .setting-group select { width: 100%; padding: 10px; background: #1a1a2e; color: white; border: 1px solid #444; border-radius: 4px; }

        .battery-container { width: 80px; height: 12px; background: #222; margin: 5px auto; border: 1px solid #444; }
        .battery-level { height: 100%; transition: width 0.3s; }
    </style>
</head>
<body>

    <canvas id="boids-canvas"></canvas>

    <h1>Tiny-VAC // CORE</h1>

    <div class="status-box">
        <div id="connection-status">CONNECTING...</div>
        <div id="subscription-status">GROUPS: WAITING</div>
    </div>

    <div class="dashboard">
        <div class="alarms">
            <h2>ALARMS ▼</h2>
            <ul class="message-list" id="messages"></ul>
        </div>

        <div class="devices">
            <h2>DEVICES ▼</h2>
            <ul class="device-list" id="active-devices"></ul>
        </div>
    </div>

    <div id="settings-ui">
        <div id="settings-close" style="float:right; cursor:pointer; color:var(--neon-red);">[X]</div>
        <h3 style="text-align: center; font-family: 'Orbitron'; color: var(--neon-blue);">SETTINGS</h3>

        <div id="battery-indicator" style="text-align: center;">
            <div class="battery-container"><div class="battery-level" id="battery-level-display"></div></div>
            <div style="font-size: 12px;" id="battery-level-text">0%</div>
        </div>

        <div class="pressure-label">
            <div style="text-align:center;"><label style="display:block; font-size:10px;">SET</label><span class="set-pressure">N/A</span></div>
            <div style="text-align:center;"><label style="display:block; font-size:10px;">REAL</label><span class="real-pressure">N/A</span></div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <button class="settings-button settings-minus">−</button>
            <button class="settings-button settings-plus">+</button>
        </div>

        <div class="setting-group">
            <label>Leak Alarm</label>
            <select id="leak-alarm"><option value="15">15s</option><option value="30">30s</option><option value="60">1m</option><option value="120">2m</option><option value="OFF">OFF</option></select>
        </div>
        <div class="setting-group">
            <label>Canister Full</label>
            <select id="canister-full"><option value="+20">+20</option><option value="+40">+40</option><option value="+80">+80</option><option value="A">A</option><option value="OFF">OFF</option></select>
        </div>
        <div class="setting-group">
            <label>Blockage</label>
            <select id="blockage"><option value="15">15s</option><option value="30">30s</option><option value="60">1m</option><option value="120">2m</option><option value="OFF">OFF</option></select>
        </div>
        <div class="setting-group">
            <label>Sound Alarm</label>
            <select id="sound-alarm"><option value="ON">ON</option><option value="OFF">OFF</option></select>
        </div>
        <div class="setting-group">
            <label>Battery Alarm</label>
            <select id="battery-alarm"><option value="ON">ON</option><option value="OFF">OFF</option></select>
        </div>

        <button class="settings-button settings-start">START</button>
        <button class="settings-button settings-save">SAVE</button>
    </div>

    <script>
        /** --- BOIDS ENGINE (SUBTLE CYBER WEB) --- **/
        const canvas = document.getElementById('boids-canvas');
        const ctx = canvas.getContext('2d');
        let boids = [];
        const numBoids = 60;
        const maxDist = 120;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        class Boid {
            constructor() {
                this.position = { x: Math.random() * canvas.width, y: Math.random() * canvas.height };
                this.velocity = { x: (Math.random() - 0.5) * 1.2, y: (Math.random() - 0.5) * 1.2 };
            }
            draw() {
                ctx.fillStyle = "rgba(0, 242, 255, 0.2)";
                ctx.beginPath(); ctx.arc(this.position.x, this.position.y, 1.5, 0, Math.PI * 2); ctx.fill();
            }
            update() {
                this.position.x += this.velocity.x;
                this.position.y += this.velocity.y;
                if (this.position.x > canvas.width) this.position.x = 0;
                if (this.position.x < 0) this.position.x = canvas.width;
                if (this.position.y > canvas.height) this.position.y = 0;
                if (this.position.y < 0) this.position.y = canvas.height;
            }
            connect(boids) {
                for (let other of boids) {
                    let d = Math.sqrt((this.position.x - other.position.x)**2 + (this.position.y - other.position.y)**2);
                    if (other != this && d < maxDist) {
                        ctx.strokeStyle = `rgba(0, 242, 255, ${(1 - d/maxDist) * 0.15})`;
                        ctx.lineWidth = 0.5;
                        ctx.beginPath();
                        ctx.moveTo(this.position.x, this.position.y);
                        ctx.lineTo(other.position.x, other.position.y);
                        ctx.stroke();
                    }
                }
            }
        }

        for (let i = 0; i < numBoids; i++) boids.push(new Boid());

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let boid of boids) {
                boid.connect(boids);
                boid.update();
                boid.draw();
            }
            requestAnimationFrame(animate);
        }
        animate();

        /** --- YOUR ORIGINAL JS LOGIC - UNTOUCHED --- **/
        let client;
        let deviceHeartbeats = {};
        let currentDevice = "";

        function getUrlParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        const username = getUrlParam("username");
        const password = getUrlParam("password");
        const topics = getUrlParam("topics") ? getUrlParam("topics").split(",") : [];
        const brokerUrl = "wss://tinyvacmqtt188.cloud.shiftr.io";

        function connectMQTT() {
            client = mqtt.connect(brokerUrl, { username, password });
            client.on("connect", function () {
                $("#connection-status").text("CONNECTED").css("color", "var(--neon-green)");
                client.subscribe('vacAlarms');
                if (topics.length > 0) {
                    topics.forEach(topic => client.subscribe(topic));
                    $("#subscription-status").text("GROUPS: " + topics.join(", ")).css("color", "var(--neon-blue)");
                }
            });
            client.on("message", function (topic, message) {
                handleMessage(topic, message.toString());
            });
        }

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false });
        }

        function handleMessage(topic, message) {
            try {
                const parsed = JSON.parse(message);
                const deviceName = parsed.deviceName || "Unknown";
                const batteryLevel = parsed.batteryLevel ?? "N/A";
                const status = parsed.status || "Unknown";
                const type = parsed.type || "info";
                const msgContent = parsed.message || "No message";
                const timestamp = getCurrentTime();
                
                if (!deviceHeartbeats[deviceName]) { deviceHeartbeats[deviceName] = {}; }
                deviceHeartbeats[deviceName].lastSeen = Date.now();
                deviceHeartbeats[deviceName].batteryLevel = batteryLevel;
                deviceHeartbeats[deviceName].status = status;
                deviceHeartbeats[deviceName].setPressure = parsed.setPressure;
                deviceHeartbeats[deviceName].realPressure = parsed.realPressure;
                deviceHeartbeats[deviceName].therapyEnabled = parsed.therapyEnabled;
                deviceHeartbeats[deviceName].deviceTopic = parsed.topic;
                deviceHeartbeats[deviceName].alarmSettings = parsed.alarmSettings;

                updateUI(deviceName, parsed);

                // UI NODE LOGIC
                if (batteryLevel !== "N/A" && status !== "Unknown") {
                    let deviceText = `${deviceName} ${batteryLevel}% | Status: ${status}`;
                    let icon = `<span class="settings-icon" onclick="openSettings('${deviceName}')">⚙️</span>`;
                    let deviceElement = $(`#${deviceName}`);
                    let newClass = (status === "Alarm" || status === "Warning") ? "device-warning" : "device-online";

                    if (deviceElement.length) {
                        deviceElement.removeClass("device-offline device-online device-warning").addClass(newClass).html(`<span>${deviceText}</span> ${icon}`);
                    } else {
                        $("#active-devices").append(`<li id="${deviceName}" class="${newClass}"><span>${deviceText}</span> ${icon}</li>`);
                        deviceElement = $(`#${deviceName}`);
                    }
                    
                    // BLINK TRIGGER
                    deviceElement.addClass("blink-active");
                    setTimeout(() => deviceElement.removeClass("blink-active"), 400);
                }

                // UNIFIED ALERTS LIST LOGIC
                if (type === "Alarm" || type === "Warning") {
                    let alertClass = type === "Alarm" ? "alert-item" : "warning-item";
                    $("#messages").prepend(`
                        <li class="${alertClass}">
                            <span><b>${deviceName}:</b> ${msgContent}</span>
                            <span style="font-size: 10px; opacity: 0.6;">${timestamp}</span>
                        </li>`);
                }
            } catch (e) { console.error("JSON Error", e); }
        }

        function updateUI(deviceName, data) {
            if (currentDevice === deviceName) {
                if (data.realPressure !== undefined) { $(".real-pressure").text(data.realPressure); }
                if (data.therapyEnabled !== undefined) {
                    $(".settings-start").text(data.therapyEnabled === 1 ? "STOP" : "START").css("background", data.therapyEnabled === 1 ? "var(--neon-red)" : "green");
                }
                if (data.batteryLevel !== undefined) { updateBatteryDisplay(data.batteryLevel); }
            }
        }

        function updateBatteryDisplay(level) {
            const color = level <= 20 ? "var(--neon-red)" : (level <= 50 ? "#ff0" : "var(--neon-green)");
            $("#battery-level-display").css({"background": color, "width": level + "%"});
            $("#battery-level-text").text(level + "%");
        }

        function openSettings(deviceName) {
            currentDevice = deviceName;
            const info = deviceHeartbeats[deviceName];
            $("#settings-ui").fadeIn(200);
            if (info) {
                $(".set-pressure").text(info.setPressure ?? "N/A");
                $(".real-pressure").text((info.realPressure ?? "N/A"));
                $(".settings-start").text(info.therapyEnabled === 1 ? "STOP" : "START").css("background", info.therapyEnabled === 1 ? "var(--neon-red)" : "green");
                updateBatteryDisplay(info.batteryLevel !== "N/A" ? info.batteryLevel : 0);
                if (info.alarmSettings) {
                    $("#leak-alarm").prop('selectedIndex', parseInt(info.alarmSettings[0]));
                    $("#canister-full").prop('selectedIndex', parseInt(info.alarmSettings[1]));
                    $("#blockage").prop('selectedIndex', parseInt(info.alarmSettings[2]));
                    $("#sound-alarm").prop('selectedIndex', parseInt(info.alarmSettings[3]));
                    $("#battery-alarm").prop('selectedIndex', parseInt(info.alarmSettings[4]));
                }
            }
        }

        $("#settings-close").click(() => $("#settings-ui").fadeOut(200));

        $(".settings-plus").click(() => {
            let val = parseInt($(".set-pressure").text()) || 0;
            if (val < 300) $(".set-pressure").text(val + 10);
        });

        $(".settings-minus").click(() => {
            let val = parseInt($(".set-pressure").text()) || 0;
            if (val > 10) $(".set-pressure").text(val - 10);
        });

        $(".settings-start").click(() => {
            const info = deviceHeartbeats[currentDevice];
            if (info) {
                const newState = info.therapyEnabled === 1 ? 0 : 1;
                const payload = JSON.stringify({
                    deviceName: currentDevice, command: "updateSettings", therapyEnabled: newState,
                    setPressure: parseInt($(".set-pressure").text()),
                    leakAlarm: $("#leak-alarm").val(), canisterFull: $("#canister-full").val(), blockage: $("#blockage").val(),
                    soundAlarm: $("#sound-alarm").val(), batteryAlarm: $("#battery-alarm").val()
                });
                client.publish(`${info.deviceTopic}/${currentDevice}/settings`, payload);
                info.therapyEnabled = newState;
                updateUI(currentDevice, {therapyEnabled: newState});
            }
        });

        $(".settings-save").click(() => {
            const info = deviceHeartbeats[currentDevice];
            if (info) {
                const alarmStr = [$("#leak-alarm").prop('selectedIndex'), $("#canister-full").prop('selectedIndex'), $("#blockage").prop('selectedIndex'), $("#sound-alarm").prop('selectedIndex'), $("#battery-alarm").prop('selectedIndex')].join("");
                const payload = JSON.stringify({
                    deviceName: currentDevice, command: "updateSettings",
                    setPressure: parseInt($(".set-pressure").text()), therapyEnabled: info.therapyEnabled, alarmSettings: alarmStr
                });
                client.publish(`${info.deviceTopic}/${currentDevice}/settings`, payload);
                $("#settings-ui").fadeOut(200);
            }
        });

        setInterval(() => {
            const now = Date.now();
            for (let d in deviceHeartbeats) {
                if (now - deviceHeartbeats[d].lastSeen >= 20000) {
                    $(`#${d}`).removeClass("device-online device-warning").addClass("device-offline").text(`${d} - Offline`);
                }
            }
        }, 5000);

        connectMQTT();
    </script>
</body>
</html>
